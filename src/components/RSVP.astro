---
import Menu from './Menu.astro';
import { useTranslations } from '../i18n/utils';
import type { BaseComponentProps } from '../types';

export interface Props extends BaseComponentProps {
  t?: any; // Make t optional
}

const { lang = 'en', t } = Astro.props;

// Ensure we have a valid translation function
const validT = t || useTranslations(lang);
---

<div class="min-h-screen flex flex-col">
  <!-- Skip link for screen readers -->
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-white focus:px-4 focus:py-2 focus:border focus:border-gray-300"
  >
    {validT('common.skipToContent')}
  </a>

  <!-- Menu - fixed at top -->
  <header class="flex-shrink-0">
    <Menu lang={lang} t={validT} />
  </header>

  <!-- Main content area -->
  <main id="main-content" class="flex-1 flex flex-col p-6 md:p-8">
    <!-- Page Title -->
    <div class="text-center mb-8 md:mb-12 lg:mb-20 flex-shrink-0">
      <h1
        class="text-gray-800 uppercase tracking-wider font-normal text-2xl sm:text-4xl"
        style="letter-spacing: 4px;"
      >
        {validT('rsvp.title')}
      </h1>
    </div>

    <!-- Page Content -->
    <div class="flex-1 flex justify-center">
      <div class="w-full max-w-3xl">
        <form
          id="rsvp-form"
          class="space-y-4 md:space-y-6"
          action="/api/rsvp"
          method="POST"
          novalidate
        >
          <!-- Hidden language field -->
          <input type="hidden" name="language" value={lang} />
          <!-- Attendance -->
          <fieldset>
            <legend class="form-label">
              {validT('rsvp.form.attendance')}
              <span class="text-red-500" aria-label={validT('common.required')}>*</span>
            </legend>
            <div class="flex gap-6">
              <label class="flex items-center cursor-pointer">
                <input
                  type="radio"
                  id="attendance-yes"
                  name="attendance"
                  value="yes"
                  class="form-radio"
                  aria-describedby="attendance-error"
                  required
                />
                <span class="ml-2 text-gray-700 font-normal"
                  >{validT('rsvp.form.attendanceYes')}</span
                >
              </label>
              <label class="flex items-center cursor-pointer">
                <input
                  type="radio"
                  id="attendance-no"
                  name="attendance"
                  value="no"
                  class="form-radio"
                  aria-describedby="attendance-error"
                  required
                />
                <span class="ml-2 text-gray-700 font-normal"
                  >{validT('rsvp.form.attendanceNo')}</span
                >
              </label>
            </div>
            <div
              id="attendance-error"
              class="text-red-500 text-sm mt-1 hidden"
              role="alert"
              aria-live="polite"
            >
            </div>
          </fieldset>

          <!-- Name Fields -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="form-label">
                {validT('rsvp.form.firstName')}
                <span class="text-red-500" aria-label={validT('common.required')}>*</span>
              </label>
              <input
                type="text"
                id="firstName"
                name="firstName"
                class="form-input"
                aria-describedby="firstName-error"
                autocomplete="given-name"
                required
              />
              <div
                id="firstName-error"
                class="text-red-500 text-sm mt-1 hidden"
                role="alert"
                aria-live="polite"
              >
              </div>
            </div>
            <div>
              <label for="lastName" class="form-label">
                {validT('rsvp.form.lastName')}
                <span class="text-red-500" aria-label={validT('common.required')}>*</span>
              </label>
              <input
                type="text"
                id="lastName"
                name="lastName"
                class="form-input"
                aria-describedby="lastName-error"
                autocomplete="family-name"
                required
              />
              <div
                id="lastName-error"
                class="text-red-500 text-sm mt-1 hidden"
                role="alert"
                aria-live="polite"
              >
              </div>
            </div>
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="form-label">
              {validT('rsvp.form.email')}
              <span class="text-red-500" aria-label={validT('common.required')}>*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input"
              aria-describedby="email-error"
              autocomplete="email"
              required
            />
            <div
              id="email-error"
              class="text-red-500 text-sm mt-1 hidden"
              role="alert"
              aria-live="polite"
            >
            </div>
          </div>

          <!-- Vegetarian Option -->
          <div>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="vegetarian" name="vegetarian" class="form-checkbox" />
              <span class="ml-2 text-gray-900 font-normal">{validT('rsvp.form.vegetarian')}</span>
            </label>
          </div>

          <!-- Plus One Option -->
          <div>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" name="plusOne" id="plusOneCheckbox" class="form-checkbox" />
              <span class="ml-2 text-gray-900 font-normal">{validT('rsvp.form.plusOne')}</span>
            </label>
          </div>

          <!-- Plus One Details (Hidden by default) -->
          <div id="plusOneFields" class="hidden space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="guestFirstName" class="form-label">
                  {validT('rsvp.form.guestFirstName')}
                  <span class="text-red-500" aria-label={validT('common.requiredWhenGuest')}>*</span
                  >
                </label>
                <input
                  type="text"
                  id="guestFirstName"
                  name="guestFirstName"
                  class="form-input"
                  aria-describedby="guestFirstName-error"
                  autocomplete="given-name"
                />
                <div
                  id="guestFirstName-error"
                  class="text-red-500 text-sm mt-1 hidden"
                  role="alert"
                  aria-live="polite"
                >
                </div>
              </div>
              <div>
                <label for="guestLastName" class="form-label">
                  {validT('rsvp.form.guestLastName')}
                  <span class="text-red-500" aria-label={validT('common.requiredWhenGuest')}>*</span
                  >
                </label>
                <input
                  type="text"
                  id="guestLastName"
                  name="guestLastName"
                  class="form-input"
                  aria-describedby="guestLastName-error"
                  autocomplete="family-name"
                />
                <div
                  id="guestLastName-error"
                  class="text-red-500 text-sm mt-1 hidden"
                  role="alert"
                  aria-live="polite"
                >
                </div>
              </div>
            </div>
            <!-- Plus One Vegetarian Option -->
            <div>
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="plusOneVegetarian"
                  name="plusOneVegetarian"
                  class="form-checkbox"
                />
                <span class="ml-2 text-gray-700 font-normal"
                  >{validT('rsvp.form.guestVegetarian')}</span
                >
              </label>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="text-center pt-4">
            <button
              type="submit"
              id="submit-button"
              class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed"
              aria-describedby="submit-status"
              disabled
            >
              <span id="submit-text">{validT('rsvp.form.submit')}</span>
              <span id="submit-loading" class="hidden">{validT('rsvp.form.submitting')}</span>
            </button>
            <div id="submit-status" class="sr-only" aria-live="polite"></div>
          </div>
        </form>

        <!-- Deadline Notice -->
        <div class="mt-8 text-center">
          <p class="text-gray-500 font-normal">{validT('rsvp.deadline')}</p>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const firstName = document.getElementById('firstName');
          const lastName = document.getElementById('lastName');
          const email = document.getElementById('email');
          const submitButton = document.getElementById('submit-button');
          const attendanceRadios = document.querySelectorAll('input[name="attendance"]');

          function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          }

          function validateEmailField() {
            const emailError = document.getElementById('email-error');
            if (!email || !emailError) return true;

            const emailValue = email.value.trim();
            if (emailValue === '') {
              emailError.textContent = '';
              emailError.classList.add('hidden');
              email.classList.remove('border-red-500');
              return false;
            }

            if (!isValidEmail(emailValue)) {
              emailError.textContent = 'Please enter a valid email address';
              emailError.classList.remove('hidden');
              email.classList.add('border-red-500');
              return false;
            }

            emailError.textContent = '';
            emailError.classList.add('hidden');
            email.classList.remove('border-red-500');
            return true;
          }

          function validateForm() {
            const isFirstNameValid = firstName && firstName.value.trim() !== '';
            const isLastNameValid = lastName && lastName.value.trim() !== '';
            const isEmailValid = email && email.value.trim() !== '' && isValidEmail(email.value.trim());
            const isAttendanceSelected = Array.from(attendanceRadios).some(radio => radio.checked);

            const isFormValid = isFirstNameValid && isLastNameValid && isEmailValid && isAttendanceSelected;

            if (submitButton) {
              submitButton.disabled = !isFormValid;
            }
          }

          // Add listeners to all required fields
          if (firstName) firstName.addEventListener('input', validateForm);
          if (lastName) lastName.addEventListener('input', validateForm);
          if (email) {
            email.addEventListener('input', function() {
              validateForm();
              validateEmailField();
            });
            email.addEventListener('blur', validateEmailField);
          }
          
          attendanceRadios.forEach(radio => {
            radio.addEventListener('change', validateForm);
          });

          // Initial validation
          validateForm();
        });
      </script>

    </div>
  </main>
</div>
