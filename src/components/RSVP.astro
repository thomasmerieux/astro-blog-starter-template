---
import PageWrapper from './PageWrapper.astro';
import type { BaseComponentProps } from '../types';

export interface Props extends BaseComponentProps {}

const { lang = 'en', t } = Astro.props;
---

<PageWrapper title={t("rsvp.title")} lang={lang} t={t}>
  <div class="w-full max-w-3xl">
    <!-- Success/Error Messages -->
    <div id="form-messages" class="mb-6 hidden">
      <div id="success-message" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4 hidden" role="alert">
        <p class="font-medium">Thank you for your RSVP!</p>
        <p class="text-sm">We've received your response and look forward to celebrating with you.</p>
      </div>
      <div id="error-message" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4 hidden" role="alert">
        <p class="font-medium">There was an error submitting your RSVP</p>
        <p id="error-details" class="text-sm"></p>
      </div>
    </div>

    <form id="rsvp-form" class="space-y-4 md:space-y-6" novalidate>
      <!-- Hidden language field -->
      <input type="hidden" name="language" value={lang}>
      <!-- Attendance -->
      <fieldset>
        <legend class="form-label">
          {t("rsvp.form.attendance")} <span class="text-red-500" aria-label="required">*</span>
        </legend>
        <div class="flex gap-6">
          <label class="flex items-center cursor-pointer">
            <input type="radio" id="attendance-yes" name="attendance" value="yes" class="form-radio" aria-describedby="attendance-error" required>
            <span class="ml-2 text-gray-700 font-normal">{t("rsvp.form.attendanceYes")}</span>
          </label>
          <label class="flex items-center cursor-pointer">
            <input type="radio" id="attendance-no" name="attendance" value="no" class="form-radio" aria-describedby="attendance-error" required>
            <span class="ml-2 text-gray-700 font-normal">{t("rsvp.form.attendanceNo")}</span>
          </label>
        </div>
        <div id="attendance-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="polite"></div>
      </fieldset>

      <!-- Name Fields -->
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label for="firstName" class="form-label">
            {t("rsvp.form.firstName")} <span class="text-red-500" aria-label="required">*</span>
          </label>
          <input type="text" id="firstName" name="firstName" class="form-input" 
                 aria-describedby="firstName-error" 
                 autocomplete="given-name" 
                 required>
          <div id="firstName-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="polite"></div>
        </div>
        <div>
          <label for="lastName" class="form-label">
            {t("rsvp.form.lastName")} <span class="text-red-500" aria-label="required">*</span>
          </label>
          <input type="text" id="lastName" name="lastName" class="form-input" 
                 aria-describedby="lastName-error" 
                 autocomplete="family-name" 
                 required>
          <div id="lastName-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="polite"></div>
        </div>
      </div>

      <!-- Email -->
      <div>
        <label for="email" class="form-label">
          {t("rsvp.form.email")} <span class="text-red-500" aria-label="required">*</span>
        </label>
        <input type="email" id="email" name="email" class="form-input" 
               aria-describedby="email-error" 
               autocomplete="email" 
               required>
        <div id="email-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="polite"></div>
      </div>

      <!-- Vegetarian Option -->
      <div>
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" id="vegetarian" name="vegetarian" class="form-checkbox">
          <span class="ml-2 text-gray-900 font-normal">{t("rsvp.form.vegetarian")}</span>
        </label>
      </div>

      <!-- Plus One Option -->
      <div>
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" name="plusOne" id="plusOneCheckbox" class="form-checkbox">
          <span class="ml-2 text-gray-900 font-normal">I will bring someone</span>
        </label>
      </div>

      <!-- Plus One Details (Hidden by default) -->
      <div id="plusOneFields" class="hidden space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label for="plusOneFirstName" class="form-label">
              Guest First Name <span class="text-red-500" aria-label="required when bringing a guest">*</span>
            </label>
            <input type="text" id="plusOneFirstName" name="plusOneFirstName" class="form-input"
                   aria-describedby="plusOneFirstName-error"
                   autocomplete="given-name">
            <div id="plusOneFirstName-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="polite"></div>
          </div>
          <div>
            <label for="plusOneLastName" class="form-label">
              Guest Last Name <span class="text-red-500" aria-label="required when bringing a guest">*</span>
            </label>
            <input type="text" id="plusOneLastName" name="plusOneLastName" class="form-input"
                   aria-describedby="plusOneLastName-error"
                   autocomplete="family-name">
            <div id="plusOneLastName-error" class="text-red-500 text-sm mt-1 hidden" role="alert" aria-live="polite"></div>
          </div>
        </div>
        <!-- Plus One Vegetarian Option -->
        <div>
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="plusOneVegetarian" name="plusOneVegetarian" class="form-checkbox">
            <span class="ml-2 text-gray-700 font-normal">Guest Vegetarian meal</span>
          </label>
        </div>
      </div>

      <!-- Message Field -->
      <div>
        <label for="message" class="form-label">
          Message for the Couple (optional)
        </label>
        <textarea id="message" name="message" class="form-input" rows="3"
                  placeholder="Share your excitement or well wishes..."
                  maxlength="500"></textarea>
      </div>

      <!-- Submit Button -->
      <div class="text-center pt-4">
        <button type="submit" id="submit-button" class="btn-primary" aria-describedby="submit-status">
          <span id="submit-text">{t("rsvp.form.submit")}</span>
          <span id="submit-loading" class="hidden">Submitting...</span>
        </button>
        <div id="submit-status" class="sr-only" aria-live="polite"></div>
      </div>
    </form>

    <!-- Deadline Notice -->
    <div class="mt-8 text-center">
      <p class="text-gray-500 font-normal">{t("rsvp.deadline")}</p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('rsvp-form');
      const submitButton = document.getElementById('submit-button');
      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');
      const submitStatus = document.getElementById('submit-status');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const errorDetails = document.getElementById('error-details');
      const formMessages = document.getElementById('form-messages');
      
      const plusOneCheckbox = document.getElementById('plusOneCheckbox');
      const plusOneFields = document.getElementById('plusOneFields');
      const plusOneFirstName = document.querySelector('input[name="plusOneFirstName"]');
      const plusOneLastName = document.querySelector('input[name="plusOneLastName"]');

      // Form validation functions
      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function showFieldError(fieldName, message) {
        const errorElement = document.getElementById(fieldName + '-error');
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.remove('hidden');
          
          // Add aria-invalid to the field
          const field = document.getElementById(fieldName) || document.querySelector(`input[name="${fieldName}"]`);
          if (field) {
            field.setAttribute('aria-invalid', 'true');
            field.classList.add('border-red-500');
          }
        }
      }

      function clearFieldError(fieldName) {
        const errorElement = document.getElementById(fieldName + '-error');
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
          
          // Remove aria-invalid from the field
          const field = document.getElementById(fieldName) || document.querySelector(`input[name="${fieldName}"]`);
          if (field) {
            field.removeAttribute('aria-invalid');
            field.classList.remove('border-red-500');
          }
        }
      }

      function clearAllErrors() {
        const errorElements = document.querySelectorAll('[id$="-error"]');
        errorElements.forEach(element => {
          element.textContent = '';
          element.classList.add('hidden');
        });
        
        const invalidFields = document.querySelectorAll('[aria-invalid="true"]');
        invalidFields.forEach(field => {
          field.removeAttribute('aria-invalid');
          field.classList.remove('border-red-500');
        });
      }

      function showMessage(type, message) {
        formMessages.classList.remove('hidden');
        
        if (type === 'success') {
          successMessage.classList.remove('hidden');
          errorMessage.classList.add('hidden');
        } else {
          errorMessage.classList.remove('hidden');
          successMessage.classList.add('hidden');
          errorDetails.textContent = message;
        }
        
        // Scroll to message
        formMessages.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function hideMessages() {
        formMessages.classList.add('hidden');
        successMessage.classList.add('hidden');
        errorMessage.classList.add('hidden');
      }

      // Plus one functionality
      if (plusOneCheckbox && plusOneFields) {
        plusOneCheckbox.addEventListener('change', function() {
          if (this.checked) {
            plusOneFields.classList.remove('hidden');
            plusOneFields.setAttribute('aria-hidden', 'false');
            // Make +1 name fields required when shown
            if (plusOneFirstName) {
              plusOneFirstName.required = true;
              plusOneFirstName.setAttribute('aria-required', 'true');
            }
            if (plusOneLastName) {
              plusOneLastName.required = true;
              plusOneLastName.setAttribute('aria-required', 'true');
            }
            // Focus first plus one field
            setTimeout(() => plusOneFirstName?.focus(), 100);
          } else {
            plusOneFields.classList.add('hidden');
            plusOneFields.setAttribute('aria-hidden', 'true');
            // Remove required attribute when hidden
            if (plusOneFirstName) {
              plusOneFirstName.required = false;
              plusOneFirstName.removeAttribute('aria-required');
              plusOneFirstName.value = '';
              clearFieldError('plusOneFirstName');
            }
            if (plusOneLastName) {
              plusOneLastName.required = false;
              plusOneLastName.removeAttribute('aria-required');
              plusOneLastName.value = '';
              clearFieldError('plusOneLastName');
            }
            // Clear vegetarian checkbox for +1
            const plusOneVegetarian = document.querySelector('input[name="plusOneVegetarian"]');
            if (plusOneVegetarian) plusOneVegetarian.checked = false;
          }
        });
      }

      // Form submission
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Clear previous errors and messages
          clearAllErrors();
          hideMessages();
          
          // Validate form
          let hasErrors = false;
          const formData = new FormData(form);
          
          // Validate required fields
          if (!formData.get('firstName')?.toString().trim()) {
            showFieldError('firstName', 'First name is required');
            hasErrors = true;
          }
          
          if (!formData.get('lastName')?.toString().trim()) {
            showFieldError('lastName', 'Last name is required');
            hasErrors = true;
          }
          
          const email = formData.get('email')?.toString().trim();
          if (!email) {
            showFieldError('email', 'Email is required');
            hasErrors = true;
          } else if (!validateEmail(email)) {
            showFieldError('email', 'Please enter a valid email address');
            hasErrors = true;
          }
          
          if (!formData.get('attendance')) {
            showFieldError('attendance', 'Please select your attendance');
            hasErrors = true;
          }
          
          // Validate plus one fields if plus one is checked
          if (formData.get('plusOne') === 'on') {
            if (!formData.get('plusOneFirstName')?.toString().trim()) {
              showFieldError('plusOneFirstName', 'Guest first name is required');
              hasErrors = true;
            }
            if (!formData.get('plusOneLastName')?.toString().trim()) {
              showFieldError('plusOneLastName', 'Guest last name is required');
              hasErrors = true;
            }
          }
          
          if (hasErrors) {
            // Focus first error field
            const firstErrorField = document.querySelector('[aria-invalid="true"]');
            if (firstErrorField) {
              firstErrorField.focus();
            }
            return;
          }
          
          // Show loading state
          submitButton.disabled = true;
          submitText.classList.add('hidden');
          submitLoading.classList.remove('hidden');
          submitStatus.textContent = 'Submitting your RSVP...';
          
          try {
            const response = await fetch('/api/rsvp', {
              method: 'POST',
              body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
              showMessage('success');
              form.reset();
              // Hide plus one fields if they were shown
              if (plusOneFields && !plusOneFields.classList.contains('hidden')) {
                plusOneFields.classList.add('hidden');
                plusOneFields.setAttribute('aria-hidden', 'true');
              }
              submitStatus.textContent = 'RSVP submitted successfully!';
            } else {
              if (result.errors) {
                // Show field-specific errors
                for (const [field, error] of Object.entries(result.errors)) {
                  showFieldError(field, error);
                }
              } else {
                showMessage('error', result.error || 'An unexpected error occurred');
              }
              submitStatus.textContent = 'Error submitting RSVP';
            }
          } catch (error) {
            console.error('RSVP submission error:', error);
            showMessage('error', 'Network error. Please check your connection and try again.');
            submitStatus.textContent = 'Network error occurred';
          } finally {
            // Reset button state
            submitButton.disabled = false;
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
          }
        });
      }
    });
  </script>
</PageWrapper>